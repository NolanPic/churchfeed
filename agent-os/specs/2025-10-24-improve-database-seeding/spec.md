# Specification: Improve Database Seeding Process

## Goal
Enhance the database seeding workflow to support image uploads (avatars and embedded post images), generate more natural conversational content across diverse feed categories, output TipTap JSON format instead of HTML, and provide clear documentation for the seeding process.

## User Stories
- As a developer, I want to seed the database with realistic images so that the UI looks complete and production-like during testing
- As a developer, I want seed data that sounds like real church community conversations so that I can properly evaluate UX and content rendering
- As a developer, I want posts and messages in TipTap JSON format so that they work correctly with the editor component
- As a developer, I want clear seeding instructions so that any team member can generate and load seed data independently

## Core Requirements

### Image Support
- Support avatar images for all seeded users
- Support embedded images within post content
- Images manually placed in predefined asset directories
- Automated upload to Convex storage during seeding
- Proper tracking in the `uploads` table
- Avatar uploads linked to users via `users.image` column

### Content Quality
- Generate natural, conversational content that sounds like real people
- Avoid "Christianese" language and marketing-speak
- Create feeds across five categories:
  - Homegroup feeds (private) - e.g. "Davidson homegroup", "Klesick homegroup"
  - Official announcements/events/resources (public) - e.g. "Announcements", "Events"
  - Book clubs (mix of open/private) - e.g. "The Anxious Generation book club"
  - Bible study groups (open) - e.g. "Philippians men's study"
  - Ministry/volunteer feeds - e.g. "Food drive", "Coffee setup"
- At least one public feed must be present (e.g. "Announcements")
- Good mix of feed categories represented

### Content Format
- All posts and messages must use TipTap JSON format
- Support for text paragraphs and embedded images in TipTap structure
- No HTML content

### Documentation
- README with step-by-step seeding instructions
- Instructions for deleting existing data in Convex dashboard
- Clear explanation of asset folder structure and naming conventions

## Visual Design
No visual mockups provided for this specification.

## Reusable Components

### Existing Code to Leverage
- **Convex Mutations**:
  - `convex/seed.ts` - Contains `seedDatabase`, `seedOrganization`, `seedUser`, `seedFeed`, `seedUserFeed`, `seedPost`, `seedMessage` mutations
  - Current pattern of processing JSON data sequentially

- **Upload System**:
  - `convex/uploads.ts` - `createUploadRecord` internal mutation for tracking uploads
  - `convex/schema.ts` - `uploads` table schema with `storageId`, `source`, `sourceId`, `userId`, `fileExtension` fields
  - `users` table has `image` field that accepts `v.id("uploads")`

- **Storage API**:
  - `ctx.storage.store(file)` for uploading files to Convex storage
  - `ctx.storage.getUrl(storageId)` for retrieving URLs

- **Content Format**:
  - Posts and messages already store `content` as string (currently HTML, will be TipTap JSON)
  - No schema changes needed for content format switch

### New Components Required
- **Asset Directory Structure**: Need to create `scripts/seed/assets/avatars/` and `scripts/seed/assets/posts/` directories for image storage
- **Image Processing Logic**: New logic in `seed.js` to:
  - Find image references in the JSON generated by the LLM
  - Read image files from asset directories
  - Upload images to Convex storage
  - Replace placeholder URLs with actual storage URLs
  - Create `uploads` table records for each image
  - Link avatar uploads to user records
- **Enhanced Prompt**: Updated `prompt.txt` with image references, feed category requirements, and TipTap JSON format examples

## Technical Approach

### 1. Asset Folder Structure
Create two directories under `scripts/seed/`:
- `assets/avatars/` - Contains avatar images with naming pattern: `man1.jpg`, `man2.jpg`, `woman1.jpg`, `woman2.jpg`, etc.
- `assets/posts/` - Contains post images with descriptive filenames: `church-basement-floor-progress.jpg`, `youth-group-pizza-party.jpg`, etc.

### 2. Updated JSON Structure

#### User Object (with avatar)
```json
{
  "email": "john@church.com",
  "name": "John Johnson",
  "image": "man4.jpg"
}
```

#### Post Object (with TipTap JSON and embedded image)
```json
{
  "content": {
    "type": "doc",
    "content": [
      {
        "type": "paragraph"
      },
      {
        "type": "image",
        "attrs": {
          "src": "PLACEHOLDER/church-basement-floor-progress.jpg",
          "alt": null,
          "title": null,
          "width": null,
          "height": null
        }
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "text": "The current progress on the new church basement flooring."
          }
        ]
      }
    ]
  },
  "feedIndex": 0,
  "userIndex": 0,
  "postedAt": 1729776000000,
  "images": ["church-basement-floor-progress.jpg"]
}
```

#### Post Object (text only, TipTap JSON)
```json
{
  "content": {
    "type": "doc",
    "content": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "text": "Hey everyone! Just a reminder that this Sunday we're starting our new series on the Book of James."
          }
        ]
      }
    ]
  },
  "feedIndex": 0,
  "userIndex": 0,
  "postedAt": 1729776000000
}
```

#### Message Object (TipTap JSON)
```json
{
  "postIndex": 0,
  "userIndex": 1,
  "content": {
    "type": "doc",
    "content": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "text": "So excited to be part of this community!"
          }
        ]
      }
    ]
  }
}
```

### 3. Updated prompt.txt

Update `scripts/seed/prompt.txt` to include:
- Instructions to reference images in the asset directories
- TipTap JSON format examples for posts and messages
- Feed category requirements (homegroups, announcements, book clubs, Bible studies, ministry feeds)
- Requirement for at least one public feed
- Instructions to avoid "Christianese" and create natural conversation
- Post `images` array field for tracking which images are referenced
- Placeholder URL format: `PLACEHOLDER/{filename}`
- Content should be TipTap JSON objects, not HTML strings

### 4. Enhanced seed.js Script

Add image processing workflow to `scripts/seed/seed.js`:

#### New Imports
```javascript
const fs = require('fs');
const path = require('path');
```

#### Image Upload Function
Create helper function to upload a single image:
```javascript
async function uploadImageToConvex(imagePath, userId, orgId, source, sourceId = undefined) {
  // Read file from disk
  const fileBuffer = fs.readFileSync(imagePath);
  const fileName = path.basename(imagePath);
  const fileExtension = path.extname(imagePath).substring(1);

  // Create Blob from buffer
  const blob = new Blob([fileBuffer]);

  // Upload to Convex storage
  const storageId = await client.mutation(api.storage.store, { file: blob });

  // Create upload record
  const uploadId = await client.mutation(api.uploads.createUploadRecord, {
    orgId,
    userId,
    storageId,
    source,
    sourceId,
    fileExtension
  });

  // Get storage URL
  const url = await client.mutation(api.storage.getUrl, { storageId });

  return { uploadId, url, storageId };
}
```

#### Process User Avatars
Before calling `seedUser` mutation:
```javascript
// For each user with an image field
if (user.image) {
  const imagePath = path.join(__dirname, 'assets', 'avatars', user.image);
  if (fs.existsSync(imagePath)) {
    // Upload image first
    const { uploadId } = await uploadImageToConvex(
      imagePath,
      userId, // userId from just-created user
      orgId,
      'avatar',
      userId
    );

    // Update user record with upload ID
    await client.mutation(api.users.patchUserAvatar, {
      userId,
      imageUploadId: uploadId
    });
  }
}
```

#### Process Post Images
Before calling `seedPost` mutation:
```javascript
// For each post with images array
if (post.images && post.images.length > 0) {
  // Upload all referenced images
  const imageUploads = [];
  for (const imageFilename of post.images) {
    const imagePath = path.join(__dirname, 'assets', 'posts', imageFilename);
    if (fs.existsSync(imagePath)) {
      const { url } = await uploadImageToConvex(
        imagePath,
        posterId,
        orgId,
        'post'
        // Note: sourceId not set yet, will be post._id after creation
      );
      imageUploads.push({ filename: imageFilename, url });
    }
  }

  // Replace PLACEHOLDER URLs in content with actual storage URLs
  let contentStr = JSON.stringify(post.content);
  for (const { filename, url } of imageUploads) {
    contentStr = contentStr.replace(`PLACEHOLDER/${filename}`, url);
  }
  post.content = JSON.parse(contentStr);
}

// Convert content object to JSON string for storage
post.content = JSON.stringify(post.content);
```

### 5. Convex Mutation Updates

#### New Mutation: `patchUserAvatar`
Add to `convex/seed.ts`:
```typescript
export const patchUserAvatar = mutation({
  args: {
    userId: v.id("users"),
    imageUploadId: v.id("uploads"),
  },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.userId, {
      image: args.imageUploadId,
    });
  },
});
```

#### Update `seedUser` Mutation
Modify signature to accept optional `imageUploadId`:
```typescript
export const seedUser = mutation({
  args: {
    email: v.string(),
    name: v.optional(v.string()),
    orgId: v.id("organizations"),
    imageUploadId: v.optional(v.id("uploads")),
  },
  handler: async (ctx, args) => {
    // ... existing code ...

    return await ctx.db.insert("users", {
      email: args.email,
      name: args.name || args.email.split("@")[0],
      emailVerificationTime: Date.now(),
      orgId: args.orgId,
      role: "user",
      image: args.imageUploadId,
    });
  },
});
```

#### Update `seedPost` and `seedMessage` Content Validation
Current mutations already accept `content: v.string()` which works for TipTap JSON stringified format. No schema changes needed.

### 6. Image Upload Flow Summary
1. LLM generates JSON with image references in users (`"image": "man4.jpg"`) and posts (`"images": ["filename.jpg"]`, content with `PLACEHOLDER/filename.jpg`)
2. Developer manually places images in `assets/avatars/` and `assets/posts/` directories
3. `seed.js` processes JSON file:
   - For each user with `image` field: upload avatar to Convex, create `uploads` record, link to user via `users.image`
   - For each post with `images` array: upload images to Convex, create `uploads` records, replace placeholders in TipTap JSON with actual storage URLs
4. Create organizations, users, feeds, user-feed relationships, posts, messages via existing mutations
5. `uploads` table records created with:
   - `storageId` - reference to Convex `_storage`
   - `source` - "avatar", "post", or "message"
   - `sourceId` - user/post/message ID (set for avatars, optional for posts/messages)
   - `userId` - ID of user who "owns" the upload
   - `orgId` - organization ID
   - `fileExtension` - file extension

### 7. Feed Category Requirements
The prompt must instruct the LLM to create a balanced mix of feeds:
- 1-2 homegroup feeds (private)
- 1+ official announcement/event/resource feed (public) - REQUIRED
- 0-1 book club feeds (open or private)
- 1-2 Bible study feeds (open)
- 1-2 ministry/volunteer feeds (public or open)

Privacy settings:
- `public` - Anyone can view, must be member to post
- `open` - Anyone can view and join, members can post
- `private` - Invitation only, members can view and post

### 8. README Requirements

Create `scripts/seed/README.md` with sections:
1. **Overview** - What the seeding process does
2. **Prerequisites** - Required environment variables, dependencies
3. **Asset Preparation** - How to add images to asset folders, naming conventions
4. **Generating Seed Data** - Using an LLM with prompt.txt to create JSON file
5. **Loading Seed Data** - Running the seed.js script
6. **Clearing Data** - How to delete existing data from Convex dashboard before seeding
7. **Troubleshooting** - Common issues and solutions

## Out of Scope
- Automated image selection or generation
- Support for multiple organizations in seed data (staying with single org due to token limits)
- Image optimization or resizing
- Video or other media types
- Seeding for other tables (invites, etc.)
- Setting `sourceId` on uploads (clarified as not needed)
- Message content with embedded images (posts only for now)

## Success Criteria
- Seed script successfully uploads avatar and post images to Convex storage
- All seeded users have avatars displayed in the UI
- Posts with embedded images render correctly in feeds
- `uploads` table contains records for all seeded images
- Post and message content is valid TipTap JSON format
- Content sounds natural and conversational, not "Christianese"
- All five feed categories are represented in seed data
- At least one public feed exists
- Any developer can follow README and successfully seed database
- Existing `seed-data-{org}-{date}.json` file pattern is maintained
